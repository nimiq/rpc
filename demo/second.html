<button id="forward"></button>
<script src="../dist/Base64.js"></script>
<script src="../dist/JSONUtils.js"></script>
<script src="../dist/RequestIdStorage.js"></script>
<script src="../dist/UrlRpcEncoder.js"></script>
<script src="../dist/RandomUtils.js"></script>
<script src="../dist/Messages.js"></script>
<script src="../dist/State.js"></script>
<script src="../dist/RpcClient.js"></script>
<script src="../dist/RpcServer.js"></script>
<script>
    const client = new RedirectRpcClient('third.html', '*');
    const server = new RpcServer('*');

    server.onRequest('iFrameTest', (state, arg) => {
        return `iframe response to call with arg ${arg}`;
    });

    server.onRequest('test', (state, arg) => {
        document.getElementById('forward').innerText = 'Foward to third';
        document.getElementById('forward').onclick = () => {
            const searchPos = window.location.href.indexOf('?');
            client.callAndSaveLocalState(searchPos >= 0 ? window.location.href.substr(0, searchPos) : window.location.href, state.toJSON(), 'test', arg);
        };
    });

    client.onResponse('test', (result, id, stateStr) => {
        console.log(result);
        document.getElementById('forward').innerText = 'Foward to parent';
        document.getElementById('forward').onclick = () => {
            // Reply to main
            const state = State.fromJSON(stateStr);
            state.reply(ResponseStatus.OK, result);
        };
    }, (error, id, stateStr) => {
        const state = State.fromJSON(stateStr);
        state.reply(ResponseStatus.ERROR, error);
    });

    client.init().then(() => {});
    server.init();
</script>
